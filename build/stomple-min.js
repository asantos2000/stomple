/*
* @license
* @preserve,
* The MIT License
* --
* Copyright (c) <2010> Karl Krukow <karl.krukow@gmail.com>
*
* Permission is hereby granted, free of charge, to any person obtaining a copy
* of this software and associated documentation files (the "Software"), to deal
* in the Software without restriction, including without limitation the rights
* to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
* copies of the Software, and to permit persons to whom the Software is
* furnished to do so, subject to the following conditions:
*
* The above copyright notice and this permission notice shall be included in
* all copies or substantial portions of the Software.
*
* THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
* IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
* FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
* AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
* LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
* OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
* THE SOFTWARE.
* --
*
* @package Stomple
* @author Karl Krukow <karl.krukow@gmail.com>
* @copyright 2010 Karl Krukow <kkr@trifork.com>
* @license http://opensource.org/licenses/mit-license.php MIT License
* @link http://github.com/krukow/stomple
* @version 0.9 (beta)
*/
(function(){var f=this,l,e=function(){},b=f.console&&typeof f.console.warn==="function",a=f.console&&typeof f.console.info==="function",c;if(typeof WebSocket==="undefined"||!WebSocket||f.Stomple){if(b&&l.debug){f.console.warn(f.Stomple?"Stomple already defined.":"Stomple: WebSockets not available")}f.Stomple=f.Stomple||false;return}if(String.prototype.trim){c=function(o){return o.trim()}}else{c=function(q){q=q.replace(/^\s\s*/,"");var o=/\s/,p=q.length;while(o.test(q.charAt(--p))){}return q.slice(0,p+1)}}if(!Object.create){Object.create=(function(){function o(){}return function(t,r){o.prototype=t;var q=new o(),s;if(r){for(s in r){if(r.hasOwnProperty(s)){q[s]=r[s].value}}}return q}})()}var j=function(s,q,r){var o;if(r){for(o in q){if(q.hasOwnProperty(o)){s[o]={value:q[o]}}}}else{for(o in q){if(q.hasOwnProperty(o)){s[o]=q[o]}}}return s};var n=function(o){if(!o){return 0}var p=encodeURIComponent(o),q=/%/g,r=p.length;while(q.exec(p)){r-=2}return r};var k=function(p,o){if(!p||o<=0){return 0}var q=0,r=0,s;while(r<o){s=p.charCodeAt(q);if(s<128){r+=1}else{s=encodeURIComponent(s.charAt(q));r+=s.length/3}q+=1}if(r===o){return q}else{return q-1}};var d="\u0000";var h={command:null,headers:null,body:null,toString:function(){var o=[this.command,"\n"],p,q=this.headers;if(q){for(p in q){if(q.hasOwnProperty(p)){o.push(p);o.push(":");o.push(q[p]);o.push("\n")}}}o.push("\n");if(this.body){o.push(this.body)}o.push(d);return o.join("")}};var i=function(p){var r={};if(p.command){r.command={value:p.command}}if(p.headers){r.headers={value:p.headers}}if(p.body){r.body={value:p.body}}var q=Object.create(h,r);return q};var g={timeout:8000,autoConnect:true,autoContentLength:true,autoReceipt:true,closeOnError:true,onconnect:e,connectFailed:e,error:e,socketOpen:e,socketMessage:e,socketClose:e,socketError:e,connected:false,websocket:null,session:null,connectConfig:null,connectTimeoutId:null,msgid:null,transid:null,pending:null,subscribers:null,transactions:null,url:null,destination:null,login:null,passcode:null,connect:function(o){if(this.connected){throw new Error("Called connect when in connected state.")}this.connectConfig=o;this.doConnect(o)},send:function(o){this.checkConnectAndDo(this.doSend,o)},subscribe:function(o){this.checkConnectAndDo(this.doSubscribe,o)},unsubscribe:function(o){this.checkConnectAndDo(this.doUnsubscribe,o)},begin:function(o){this.checkConnectAndDo(this.doBegin,o)},commit:function(o){this.checkConnectAndDo(this.doCommit,o)},ack:function(o){this.checkConnectAndDo(this.doAck,o)},abort:function(o){this.checkConnectAndDo(this.doAbort,o)},disconnect:function(o){this.checkConnectAndDo(this.doDisconnect,o)},checkConnectAndDo:function(r,p,o){var q=this;if(!this.connected){if(this.autoConnect){this.connect(Object.create(p,{success:{value:function(){r.call(q,p)}}}))}else{throw new Error("Not connected (and autoConnect is false)")}}else{r.call(this,p)}},doConnect:function(p){var q=this,o=this.websocket=new WebSocket(this.url),r=i({command:"CONNECT",headers:{login:p.login||this.login,passcode:p.passcode||this.passcode}});this.connectTimeoutId=setTimeout(function(){q.connectTimeoutId=null;q.handleConnectFailed({reason:"timeout",frame:r,websocket:this.websocket})},p.timeout||this.timeout);o.onopen=function(){q.handleOpen(r,p)};o.onmessage=function(s){q.handleMessage(s)};o.onclose=function(s){q.handleClose(s)};o.onerror=function(){q.handleError()}},transmitFrame:function(q){var o=q.spec,u=q.command,r=this,t=this.makeClientFrame(u,o),v,s=typeof o.failure==="function",p=t.headers.receipt;if(typeof q.beforeSend==="function"){q.beforeSend(t)}console.log(">>>>\n"+t.toString());if(this.websocket.send(t.toString())){if(typeof q.onSend==="function"){q.onSend(t)}v=setTimeout(function(){if(typeof q.onTimeout==="function"){q.onTimeout(t)}if(p){delete r.pending[p]}if(s){o.failure({reason:"timeout",frame:t,websocket:this.websocket})}},o.timeout||this.timeout);if(p){if(typeof q.makeReceiptHandler==="function"){this.pending[p]=q.makeReceiptHandler(o,v,t)}else{this.pending[p]=this.makeReceiptHandler(o,v,t)}}return t}else{if(typeof q.onFail==="function"){q.onFail(t)}if(s){o.failure({reason:"io",frame:t,websocket:this.websocket})}return false}},doSend:function(o){return this.transmitFrame({command:"SEND",spec:o})},doSubscribe:function(o){var p=this;return this.transmitFrame({command:"SUBSCRIBE",spec:o,onTimeout:function(r){var q=r.headers.destination;p.removeSubscriber(q,o)},onSend:function(r){var q=r.headers.destination;p.subscribers[q]=p.subscribers[q]||[];p.subscribers[q].push(o)},makeReceiptHandler:function(q,t,s){var r=s.headers.destination;return p.makeReceiptHandler(Object.create(q,{failure:{value:function(u){p.removeSubscriber(r,q);if(typeof q.failure==="function"){q.failure(u)}}}}),t,s)}})},doUnsubscribe:function(o){var p=this;return this.transmitFrame({command:"UNSUBSCRIBE",spec:o,beforeSend:function(r){var q=r.headers.destination;p.removeSubscriber(q,o)}})},doBegin:function(o){var q=this,r,p;r=o.transaction;if(typeof r==="undefined"||r===null){r=this.session+"-t-"+(++this.transid)}p={id:r,msgs:[]};return this.transmitFrame({command:"BEGIN",spec:o,beforeSend:function(s){s.headers.transaction=s.headers.transaction||r},onSend:function(s){q.transactions.push(p)},onTimeout:function(s){q.removeTransaction(p)},makeReceiptHandler:function(s,u,t){return q.makeReceiptHandler(Object.create(s,{failure:{value:function(v){q.removeTransaction(p);if(typeof s.failure==="function"){s.failure(v)}}}}),u,t)}})},doCommit:function(o){var p=this;return this.transmitFrame({command:"COMMIT",spec:o,beforeSend:function(q){p.transactions.pop()}})},doAck:function(o){var p=this;return this.transmitFrame({command:"ACK",spec:o})},doAbort:function(o){var p=this;return this.transmitFrame({command:"ABORT",spec:o,beforeSend:function(q){p.transactions.pop()}})},doDisconnect:function(o){return this.transmitFrame({command:"DISCONNECT",spec:o})},handleConnect:function(p){var o=p.frame;if(this.connectTimeoutId){clearTimeout(this.connectTimeoutId);this.connectTimeoutId=null}this.connected=true;this.session=o.headers.session||"";this.msgid=0;this.transid=0;this.onconnect(p);if(this.connectConfig&&typeof this.connectConfig.success==="function"){this.connectConfig.success(p)}},handleConnectFailed:function(o){if(this.connectTimeoutId){clearTimeout(this.connectTimeoutId);this.connectTimeoutId=null}this.connected=false;this.session=null;this.msgid=null;this.transid=null;this.connectFailed(o);if(this.connectConfig&&typeof this.connectConfig.failure==="function"){this.connectConfig.failure(o)}},handleOpen:function(p,o){if(this.socketOpen(p)===false){this.websocket.close();return}this.websocket.send(p.toString())},handleClose:function(o){if(this.connectTimeoutId){clearTimeout(this.connectTimeoutId);if(this.connectConfig&&typeof this.connectConfig.failure==="function"){this.connectConfig.failure(o)}}this.destroy()},handleError:function(){if(this.socketError()!==false&&this.closeOnError){if(this.connectTimeoutId){clearTimeout(this.connectTimeoutId);if(this.connectConfig&&typeof this.connectConfig.failure==="function"){this.connectConfig.failure()}}if(this.websocket){this.websocket.close()}}},handleMessage:function(q){var F=q.data,z=F.indexOf("\n"),r,y=F.substring(0,z),E=F.substring(z+1),x=null,D=/(.+):(.+)/g,t=E.indexOf("\n\n"),p=E.substring(0,t),o={},A,v,w=E.substring(t+2),s,u;while((x=D.exec(p))){o[c(x[1])]=c(x[2])}s=o["content-length"];if(s){try{s=parseInt(s,10)}catch(C){s=null}}if(s){w=w.substring(0,k(w,s))}else{z=w.indexOf(d);w=w.substring(0,(z===-1)?w.length:z)}var B=i({command:y,headers:o,body:w});console.log("<<<<\n"+B.toString());switch(y){case"CONNECTED":this.handleConnect({frame:B,websocket:this.websocket});break;case"MESSAGE":A=this.subscribers[o.destination];if(A){for(z=0,r=A.length;z<r;z+=1){v=A[z];v.handler.call(v.scope||f,B)}}break;case"RECEIPT":u=this.pending[o["receipt-id"]||"0"];if(u&&typeof u.success==="function"){u.success(u.frame)}break;case"ERROR":u=this.pending[o["receipt-id"]||"0"];if(u&&typeof u.failure==="function"){u.failure(u.frame)}if(typeof this.error==="function"){this.error(u.frame)}break}},makeClientFrame:function(t,p){var r={destination:p.destination||this.destination},o={command:t,headers:r,body:p.body},s=p.options||{},q;if((s.receipt!==false)&&(this.autoReceipt||s.receipt)){r.receipt=s.receipt||this.session+"-m-"+(++this.msgid)}if(t!=="SUBSCRIBE"&&(s.contentLength!==false)&&(this.autoContentLength||(typeof s.contentLength==="number"||s.contentLength))){if(typeof s.contentLength==="number"){r["content-length"]=""+s.contentLength}else{r["content-length"]=""+n(p.body)}}if((s.transaction!==false)&&(this.transactions.length>0||s.transaction)){r.transaction=s.transaction||this.transactions[this.transactions.length-1].id}if(s.headers){j(r,s.headers)}return i(o)},makeReceiptHandler:function(o,q,p){return{success:function(){clearTimeout(q);if(typeof o.success==="function"){o.success(p)}},failure:function(r){clearTimeout(q);if(typeof o.failure==="function"){o.failure(r)}},frame:p}},removeSubscriber:function(o,q){var p=this.subscribers[o],r;if(p){r=p.length;while(r--){if(p[r]===q){p.splice(r,1);return q}}}return false},removeTransaction:function(p){var o=this.transactions,q=o.length;while(q--){if(o[q]===p){o.splice(q,1);return p}}return false},removeTransactionById:function(p){var o=this.transactions,q=o.length;while(q--){if(o[q].id===p){p=o[q];o.splice(q,1);return p}}return false},destroy:function(){this.connected=false;this.session=null;this.msgid=null;this.transid=null;this.websocket=null;this.connectConfig=null;this.connectTimeoutId=null;this.pending=null;this.subscribers=null;this.transactions=null;this.url=null;this.destination=null;this.login=null;this.passcode=null}};var m=function(p){var q=p.url,o=p.destination;if(!q||typeof(q=q.valueOf())!=="string"){throw TypeError("Must supply url of type string when calling create_client")}var r={pending:{value:[]},subscribers:{value:[]},transactions:{value:[]},login:{value:""},passcode:{value:""}};return Object.create(g,j(r,p,true))};l={create_client:m,ClientPrototype:g,FramePrototype:h};f.Stomple=l})();